<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><link rel="icon" href="/k102.svg" type="image/svg+xml"/><title>Own rides map</title><meta name="next-head-count" content="4"/><link rel="preconnect" href="/" crossorigin="anonymous"/><link rel="preload" href="/_next/static/css/67b6aa43d246d2f5.css" as="style"/><link rel="stylesheet" href="/_next/static/css/67b6aa43d246d2f5.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-59c5c889f52620d6.js" defer=""></script><script src="/_next/static/chunks/framework-2c79e2a64abdb08b.js" defer=""></script><script src="/_next/static/chunks/main-ac344eb87244516d.js" defer=""></script><script src="/_next/static/chunks/pages/_app-39235841eab3c940.js" defer=""></script><script src="/_next/static/chunks/675-b52e4577ca3fdad8.js" defer=""></script><script src="/_next/static/chunks/pages/mapping-c2edaab7462bd5db.js" defer=""></script><script src="/_next/static/lFSDiHAowKGjvwnA8z5Vc/_buildManifest.js" defer=""></script><script src="/_next/static/lFSDiHAowKGjvwnA8z5Vc/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div><div class="flex justify-content-center flex-wrap header" style="display:flex;gap:10px"><span class="p-image p-component" data-pc-name="image" data-pc-section="root"><img src="k102.svg" class="" height="40" data-pc-section="image"/></span><div class="button" severity="secondary">_about</div><div class="button" severity="secondary">_photos</div></div><div class="paper"><div class="card"><div><pre>

████████████████████
█    ° °   ███     █
█    ° °  █████    █
█°°°°°°°°°██ ██°°°°█
█°°°°°°°°°█████°°°°█
█    ° °   ███     █
█    ° °    █      █
█°°°°°°°°°°°°°°°°°°█
█°°°°°°°°°°°°°°°°°°█
████████████████████</pre></div><h1>Own rides map</h1><div><h3>Why</h3><p>So, I have realized that I <i>need</i> to draw a map of my rides, and do it myself. Yeah, I know that there are a lot of tools out there, but this is not fun. I mean, doing what others have already done way better while suffering is fun, right?</p><h3>How</h3><p>I use Strava, so I have decided to check how can it help me. You can actually export all your data from it. To do so, go to your account settings, you are looking for &quot;Delete&quot; section.</p><div style="position:relative;height:400px;cursor:pointer"><button popovertarget="pop_/1/delete.png"><img alt="Image" src="/1/delete.png" decoding="async" data-nimg="fill" loading="lazy" style="position:absolute;height:100%;width:100%;left:0;top:0;right:0;bottom:0;object-fit:contain;color:transparent"/></button></div><div id="pop_/1/delete.png" class="img-dialog" popover="auto"><div class="dlg-header"><p style="color:white">/1/delete.png</p><button class="close-btn" popovertarget="pop_/1/delete.png" popovertargetaction="hide">close</button></div><div class="img-container" style="background:url(/1/delete.png) no-repeat 50% 50%;background-size:contain"></div></div><p>After pressing the &quot;Get started&quot; button, you will be able to &quot;Request Your Archive&quot; on the next page. You will get a zip archive soon after requesting it.</p><div style="position:relative;height:400px;cursor:pointer"><button popovertarget="pop_/1/gpxs.png"><img alt="Image" src="/1/gpxs.png" decoding="async" data-nimg="fill" loading="lazy" style="position:absolute;height:100%;width:100%;left:0;top:0;right:0;bottom:0;object-fit:contain;color:transparent"/></button></div><div id="pop_/1/gpxs.png" class="img-dialog" popover="auto"><div class="dlg-header"><p style="color:white">/1/gpxs.png</p><button class="close-btn" popovertarget="pop_/1/gpxs.png" popovertargetaction="hide">close</button></div><div class="img-container" style="background:url(/1/gpxs.png) no-repeat 50% 50%;background-size:contain"></div></div><p>Great, right?</p><h4>No.</h4><p>The thing is, I use Suunto 5 watches to record my activities. It&#x27;s good, but its output is not a gpx, but a fit file, even an archived one. So, along with some gpx files (I used Garmin Edge before), I have received a bunch of &#x27;fit.gz&#x27; ones</p><p>First, I thought to try to use them as they are, but have failed to find a tool to batch convert them into the format I understand. Not that I was looking too hard, but still, It seemed not to be straightforward.</p><h4>Let&#x27;s get them from Strava then!</h4><p>For every Strava activity you may get a gpx file, that&#x27;s pretty simple</p><div style="position:relative;height:400px;cursor:pointer"><button popovertarget="pop_/1/export.png"><img alt="Image" src="/1/export.png" decoding="async" data-nimg="fill" loading="lazy" style="position:absolute;height:100%;width:100%;left:0;top:0;right:0;bottom:0;object-fit:contain;color:transparent"/></button></div><div id="pop_/1/export.png" class="img-dialog" popover="auto"><div class="dlg-header"><p style="color:white">/1/export.png</p><button class="close-btn" popovertarget="pop_/1/export.png" popovertargetaction="hide">close</button></div><div class="img-container" style="background:url(/1/export.png) no-repeat 50% 50%;background-size:contain"></div></div><p>Shortly, I&#x27;ve realized that I have to press this damn button quite a lot (yeah, I didn&#x27;t bother to count) times. So, let&#x27;s automate! It was supposed to be fun, right?</p><h4>A bit of code</h4><p>So, I have downloaded one gpx and recorded my request using Fiddler. This gave me useful headers, that I could use to get other files. Actually, you only need to send the Cooke one. After a couple of minutes I came up with the following:</p><pre class="crt"><code class="language-javascript">
fs = require(&#x27;fs&#x27;);

const save = async (activity) =&gt; {
const myHeaders = new Headers();
myHeaders.append(
  &#x27;Cookie&#x27;,
  &#x27;Cookie:
  sp=8e_strava_cbv2=true;..ff&#x27;,
);

const res = await fetch(
  `https://www.strava.com/
  activities/
  ${activity}/
  export_gpx`,
  { headers: myHeaders },
);
</code></pre><p>The only thing is, where do I get those IDs? Luckily, there is an &quot;activities&quot; file in the export I&#x27;ve done before. So it was not completely useless, yay!</p><p>So just put them into an array and call it like that</p><pre class="crt"><code class="language-javascript">
names.forEach((name) =&gt; save(name));
          </code></pre><p>Surprisingly, there seems to be no limit on such requests, so after a short while, I got all my desired files.</p><h4>Now what?</h4><p>QGIS. This is a powerful software, so I&#x27;m a bit ashamed to use it for such a small task, using like 10% of what it is capable of. But after all, I&#x27;m already using Lightroom to move a couple of sliders, so why not.</p><p>Gpx can be imported by using &quot;Layer &gt; Add Layer &gt; Add vector layer&quot; menu.</p><div style="position:relative;height:400px;cursor:pointer"><button popovertarget="pop_/1/qgis1.png"><img alt="Image" src="/1/qgis1.png" decoding="async" data-nimg="fill" loading="lazy" style="position:absolute;height:100%;width:100%;left:0;top:0;right:0;bottom:0;object-fit:contain;color:transparent"/></button></div><div id="pop_/1/qgis1.png" class="img-dialog" popover="auto"><div class="dlg-header"><p style="color:white">/1/qgis1.png</p><button class="close-btn" popovertarget="pop_/1/qgis1.png" popovertargetaction="hide">close</button></div><div class="img-container" style="background:url(/1/qgis1.png) no-repeat 50% 50%;background-size:contain"></div></div><p>The only thing I actually needed was a line. After adding them all, don&#x27;t repeat my mistake and group them together, otherwise you&#x27;ll keep copying a style from one line to the whole group, QGIS will consume all the RAM it could find.</p><h4>Adding tiles</h4><div style="position:relative;height:400px;cursor:pointer"><button popovertarget="pop_/1/qgis2.png"><img alt="Image" src="/1/qgis2.png" decoding="async" data-nimg="fill" loading="lazy" style="position:absolute;height:100%;width:100%;left:0;top:0;right:0;bottom:0;object-fit:contain;color:transparent"/></button></div><div id="pop_/1/qgis2.png" class="img-dialog" popover="auto"><div class="dlg-header"><p style="color:white">/1/qgis2.png</p><button class="close-btn" popovertarget="pop_/1/qgis2.png" popovertargetaction="hide">close</button></div><div class="img-container" style="background:url(/1/qgis2.png) no-repeat 50% 50%;background-size:contain"></div></div><p>I had to add some XYZ tiles. XYZ means that those tiles are obtained from a tile server by X and Y coordinates and a zoom level. You can add some manually, but it will require some manual work, which is no fun (which is still a goal of the whole thing). I have managed to find a script that will add some well-known tiles to QGIS:<br/><a href="https://raw.githubusercontent.com/klakar/QGIS_resources/master/collections/Geosupportsystem/python/qgis_basemaps.py">qgis_basemaps.py</a><br/>There is a Python console (Plugins &gt; Python Console). After running this script I&#x27;ve got a nice list of differently styled tiles.</p><h3>Non-flat Earth</h3><p>So far so good, but the map is flat, while I&#x27;d like to show that I sometimes suffer riding uphill. There are several ways to add elevation data to the map, but the easiest is to use a thing called &quot;hillshade&quot;. This is pretty much self explanatory - this is a raster image of shades, produced by hills.</p><p>After quite extensive googling (while I use duckduckgo, so... ducking?), I came across this resource<br/><a href="https://asiointi.maanmittauslaitos.fi/karttapaikka/?lang=en">asiointi.maanmittauslaitos.fi</a><br/>It allows to download quite a lot of stuff, the needed hillshade among them:</p><div style="position:relative;height:400px;cursor:pointer"><button popovertarget="pop_/1/hillshade.png"><img alt="Image" src="/1/hillshade.png" decoding="async" data-nimg="fill" loading="lazy" style="position:absolute;height:100%;width:100%;left:0;top:0;right:0;bottom:0;object-fit:contain;color:transparent"/></button></div><div id="pop_/1/hillshade.png" class="img-dialog" popover="auto"><div class="dlg-header"><p style="color:white">/1/hillshade.png</p><button class="close-btn" popovertarget="pop_/1/hillshade.png" popovertargetaction="hide">close</button></div><div class="img-container" style="background:url(/1/hillshade.png) no-repeat 50% 50%;background-size:contain"></div></div><p>After &quot;ordering&quot; it, I have received a message from &quot;no-reply@maanmittauslaitos.fi&quot; with a download link. I&#x27;ve got some .tif files. Not knowing what am I supposed to do with them, I;ve just drag&#x27;n&#x27;dropped them in QGIS. Aaand it just worked, that simple.</p><h3>Styling</h3><p>To actually show the hillshade, I have put a map (OSM) on top of it, and made it&#x27;s semi-transparent</p><p>Now, combining all that I&#x27;ve done before, I have managed to display a non-flat map with my track on it, this is how it looks like</p><div style="position:relative;height:400px;cursor:pointer"><button popovertarget="pop_/1/hill.png"><img alt="Image" src="/1/hill.png" decoding="async" data-nimg="fill" loading="lazy" style="position:absolute;height:100%;width:100%;left:0;top:0;right:0;bottom:0;object-fit:contain;color:transparent"/></button></div><div id="pop_/1/hill.png" class="img-dialog" popover="auto"><div class="dlg-header"><p style="color:white">/1/hill.png</p><button class="close-btn" popovertarget="pop_/1/hill.png" popovertargetaction="hide">close</button></div><div class="img-container" style="background:url(/1/hill.png) no-repeat 50% 50%;background-size:contain"></div></div><p>Well, in reality this hill looks a bit more impressive:</p><div style="position:relative;height:400px;cursor:pointer"><button popovertarget="pop_/1/view.jpg"><img alt="Image" src="/1/view.jpg" decoding="async" data-nimg="fill" loading="lazy" style="position:absolute;height:100%;width:100%;left:0;top:0;right:0;bottom:0;object-fit:contain;color:transparent"/></button></div><div id="pop_/1/view.jpg" class="img-dialog" popover="auto"><div class="dlg-header"><p style="color:white">/1/view.jpg</p><button class="close-btn" popovertarget="pop_/1/view.jpg" popovertargetaction="hide">close</button></div><div class="img-container" style="background:url(/1/view.jpg) no-repeat 50% 50%;background-size:contain"></div></div><h3>Adding speed</h3><p>After performing all of this, I have decided to try and show my speed. Unfortunately, gpx track point does not contain speed, it looks like this:</p><pre class="crt"><code class="language-xml">
&lt;trkpt lat=&quot;60.1824680&quot; lon=&quot;24.7411490&quot;&gt;
&lt;ele&gt;35.3&lt;/ele&gt;
&lt;time&gt;2023-02-14T12:15:00Z&lt;/time&gt;
&lt;extensions&gt;
  &lt;gpxtpx:TrackPointExtension&gt;
  &lt;gpxtpx:hr&gt;76&lt;/gpxtpx:hr&gt;
  &lt;/gpxtpx:TrackPointExtension&gt;
&lt;/extensions&gt;
&lt;/trkpt&gt;
</code></pre><p>There is a useful QGIS plugin, called<!-- --> <a href="https://anitagraser.com/2019/02/02/movement-data-in-gis-20-trajectools-v1-released/">Trajectools</a>, which can be used for exactly this task.</p><div style="position:relative;height:400px;cursor:pointer"><button popovertarget="pop_/1/trajectools.png"><img alt="Image" src="/1/trajectools.png" decoding="async" data-nimg="fill" loading="lazy" style="position:absolute;height:100%;width:100%;left:0;top:0;right:0;bottom:0;object-fit:contain;color:transparent"/></button></div><div id="pop_/1/trajectools.png" class="img-dialog" popover="auto"><div class="dlg-header"><p style="color:white">/1/trajectools.png</p><button class="close-btn" popovertarget="pop_/1/trajectools.png" popovertargetaction="hide">close</button></div><div class="img-container" style="background:url(/1/trajectools.png) no-repeat 50% 50%;background-size:contain"></div></div><p>When installed It will add itself to the &quot;Processing toolbox&quot; panel. What I&#x27;ve used was &quot;Basic &gt; Add speed (m/s) to points&quot; This will create a new set of points, each of them contains a new value - speed.</p><p>Now, let&#x27;s colorize them. Unfortunately, I don&#x27;t know how to colorize a line, so here&#x27;s how to make it as line-like as possible.</p><p>First, we need to color each point according to the speed.</p><div style="position:relative;height:400px;cursor:pointer"><button popovertarget="pop_/1/speed1.png"><img alt="Image" src="/1/speed1.png" decoding="async" data-nimg="fill" loading="lazy" style="position:absolute;height:100%;width:100%;left:0;top:0;right:0;bottom:0;object-fit:contain;color:transparent"/></button></div><div id="pop_/1/speed1.png" class="img-dialog" popover="auto"><div class="dlg-header"><p style="color:white">/1/speed1.png</p><button class="close-btn" popovertarget="pop_/1/speed1.png" popovertargetaction="hide">close</button></div><div class="img-container" style="background:url(/1/speed1.png) no-repeat 50% 50%;background-size:contain"></div></div><p>Here we may create an expression which will be used to calculate the color. It can look like this:</p><pre class="crt"><code class="language-javascript">ramp_color(
&#x27;blue2red&#x27;,
scale_linear(
meters_per_sec * 3600 / 1000,
0,
30,
0,
1)
)</code></pre><p>The hell does this mean? Yeah, this language is confusing at best. Anyway, here&#x27;s what is happening here.</p><p>&quot;ramp_color&quot; - is a function to calculate the color code (hex). It takes two arguments - name of the gradient (here I&#x27;ve created my own just <i>for fun</i>, but you mau use an existing one) and a value, which should be a number from 0 to 1.</p><p>&quot;scale_linear&quot; - since we are required to give [0, 1] value to the &quot;ramp_color&quot; function, we have to normalize our &quot;meters_per_sec&quot; value. So it takes 5 arguments: the value to normalize, its minimum, its maximum, normalized minimum and normalized maximum. So, 0 will become 0, 30 km/h will become 1.</p><div style="position:relative;height:400px;cursor:pointer"><button popovertarget="pop_/1/speed2.png"><img alt="Image" src="/1/speed2.png" decoding="async" data-nimg="fill" loading="lazy" style="position:absolute;height:100%;width:100%;left:0;top:0;right:0;bottom:0;object-fit:contain;color:transparent"/></button></div><div id="pop_/1/speed2.png" class="img-dialog" popover="auto"><div class="dlg-header"><p style="color:white">/1/speed2.png</p><button class="close-btn" popovertarget="pop_/1/speed2.png" popovertargetaction="hide">close</button></div><div class="img-container" style="background:url(/1/speed2.png) no-repeat 50% 50%;background-size:contain"></div></div><p>The result is not great, but for now this is my best. On this map a hillshade and a Stamen Toner layers were used</p><h3>Done</h3><p>So, that&#x27;s it. I had some specific fun doing this and learned something new.</p></div></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/mapping","query":{},"buildId":"lFSDiHAowKGjvwnA8z5Vc","nextExport":true,"autoExport":true,"isFallback":false,"scriptLoader":[]}</script></body></html>