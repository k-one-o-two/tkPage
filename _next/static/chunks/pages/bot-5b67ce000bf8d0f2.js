(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[950],{5584:function(e,t,s){(window.__NEXT_P=window.__NEXT_P||[]).push(["/bot",function(){return s(2169)}])},9271:function(e,t,s){"use strict";s.d(t,{d:function(){return i}});var a=s(5893),n=s(9008),r=s.n(n);function i(e){let{title:t,html:s}=e;return(0,a.jsxs)("div",{className:"card",children:[(0,a.jsx)(r(),{children:(0,a.jsx)("title",{children:t})}),(0,a.jsx)("h1",{children:t}),s]})}},2169:function(e,t,s){"use strict";s.r(t);var a=s(5893),n=s(9271);t.default=function(){let e={title:"On Telegram bot development",html:(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{children:"Why"}),(0,a.jsx)("p",{children:"As you may have noticed, I like taking pictures. I also like looking at others pics and encouraging people to make and share them."}),(0,a.jsx)("p",{children:"Since I'm somewhat active in the Nerdsbay community, I have decided to create a telegram channel for people to share their photos. No discussions, just photos."}),(0,a.jsx)("p",{children:"But immediately, there is a problem - how do I let people send their images to the channel - obviously, I'd like to be able to either approve or reject those pics."}),(0,a.jsx)("h3",{children:"Let's start"}),(0,a.jsx)("p",{children:"So, we need a public channel, a private group where people will be able to approve images and a bot which will forward messages from the user to that group and then to the channel."}),(0,a.jsxs)("p",{children:["To create a bot, you have to interact with the"," ",(0,a.jsx)("a",{href:"https://t.me/BotFather",children:"bot father"})," - this is pretty straight-forward and I'm gonna skip it here."]}),(0,a.jsx)("p",{children:"We'll be using node.js, let's start with adding a couple of packages we'll need."}),(0,a.jsx)("pre",{className:"crt",children:(0,a.jsx)("code",{className:"language-javascript",children:"npm install node-telegram-bot-api"})}),(0,a.jsx)("pre",{className:"crt",children:(0,a.jsx)("code",{className:"language-javascript",children:"npm install locallydb"})}),(0,a.jsx)("p",{children:'The 1st one is the api that we\'re going to use to interact with the bot, the 2nd - a rather dumb "database".'}),(0,a.jsx)("p",{children:'The api works pretty much like a web socket - it starts polling and lets you to subscribe to some events. First of all, we need a "photo" event.'}),(0,a.jsx)("pre",{className:"crt",children:(0,a.jsx)("code",{className:"language-javascript",children:"\nconst bot = new TelegramBot(token, { polling: true });\n\nbot.on('photo', (msg) => {});\n            "})}),(0,a.jsx)("p",{children:"All the files are stored by telegram separately, so we don't actually need to download it - only memorize it's \"file_unique_id\". Let's save it to the collection:"}),(0,a.jsx)("pre",{className:"crt",children:(0,a.jsx)("code",{className:"language-javascript",children:"\nchatsArray.insert({\n  user: msg.chat.id,\n  fileId: msg.photo[0].file_unique_id,\n  msgId: msg.message_id,\n});"})}),(0,a.jsx)("p",{children:"We're going to need the id of this chat to be able to respond to the user, who sent the picture."}),(0,a.jsx)("p",{children:"Now we need to forward this message to the admin group, this is pretty straightforward as well."}),(0,a.jsx)("pre",{className:"crt",children:(0,a.jsx)("code",{className:"language-javascript",children:"bot.forwardMessage(groupID, msg.chat.id, msg.message_id);"})}),(0,a.jsx)("p",{children:"Next, the bot needs to react to the message in that group and forward the message to the channel and additionally notify the original sender that their picture has been approved (or not)."}),(0,a.jsx)("p",{children:"This is why we have saved the user id into the array - in some cases, a user can hide their username on forwarded messages - the only way to trace the user back is by the file uniq id ."}),(0,a.jsx)("pre",{className:"crt",children:(0,a.jsx)("code",{className:"language-javascript",children:"\nbot.onText(/ok\\s?(.*)/, (msg, match) => {\n  const comment = match[1]; // the captured \"comment\"\n  bot.forwardMessage(channelID, msg.chat.id, msg.reply_to_message.message_id); // forwarding to the channel\n  const savedUser = getUserByFile(fileId);\n  bot.sendMessage(\n    savedUser.user,\n    'we have approved your photo',\n    {\n      reply_to_message_id: savedUser.msgId,\n    },\n  );\n  ...\nconst getUserByFile = (fileId) => {\n  const list = chatsArray.where({ fileId });\n  if (list.length() === 0) {\n    return null;\n  }\n\n  return list.items[0];\n};\n        "})}),(0,a.jsx)("p",{children:'Here the bot reacts to a message that matches the regexp (i.e. messages like "ok we like it") if this message came as a reply to the photo in the group.'}),(0,a.jsx)("p",{children:"Additionally, you may want to check that this reply is indeed in the group or it has some approved users in it."}),(0,a.jsx)("h3",{children:"That's it"}),(0,a.jsxs)("p",{children:["You may see this code here:"," ",(0,a.jsx)("a",{href:"https://github.com/k-one-o-two/img-bot",children:"on Github."})]}),(0,a.jsx)("h3",{children:"Wait, how do I run it?"}),(0,a.jsx)("p",{children:"The good thing is that you don't need any domain or even a static IP to host this bot backend. But if you're unhappy with running it on your machine, there's a great option."}),(0,a.jsxs)("p",{children:["You can obtain an"," ",(0,a.jsx)("a",{href:"https://www.oracle.com/cloud/free/",children:"Oracle free tier"})," ","virtual machine. On which you can install any OS you like."]}),(0,a.jsxs)("p",{children:["After trying several options to run my little node script and detach it from the ssh terminal, I've found out that"," ",(0,a.jsx)("a",{href:"https://www.npmjs.com/package/forever",children:"forever"})," works nest for me."]}),(0,a.jsx)("p",{children:"So, install it and run your script:"}),(0,a.jsx)("pre",{className:"crt",children:(0,a.jsx)("code",{className:"language-javascript",children:"npm install -g forever && forever start ./app.js"})}),(0,a.jsx)("h3",{children:"Done"}),(0,a.jsx)("p",{children:"In case you'd need a telegram bot for something, you now know how to start!"})]})};return(0,a.jsx)(n.d,{title:e.title,html:e.html})}}},function(e){e.O(0,[774,888,179],function(){return e(e.s=5584)}),_N_E=e.O()}]);