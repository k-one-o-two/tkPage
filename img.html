<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><link rel="icon" href="/k102.svg" type="image/svg+xml"/><title>Image editing in node.js</title><meta name="next-head-count" content="4"/><link rel="preconnect" href="/" crossorigin="anonymous"/><link rel="preload" href="/_next/static/css/34d0361d49006aff.css" as="style"/><link rel="stylesheet" href="/_next/static/css/34d0361d49006aff.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-59c5c889f52620d6.js" defer=""></script><script src="/_next/static/chunks/framework-2c79e2a64abdb08b.js" defer=""></script><script src="/_next/static/chunks/main-ac344eb87244516d.js" defer=""></script><script src="/_next/static/chunks/pages/_app-1364cb3906eb8b37.js" defer=""></script><script src="/_next/static/chunks/675-b52e4577ca3fdad8.js" defer=""></script><script src="/_next/static/chunks/pages/img-774efec18b04416e.js" defer=""></script><script src="/_next/static/rQhHGCUC0X3V9CBDoSjU8/_buildManifest.js" defer=""></script><script src="/_next/static/rQhHGCUC0X3V9CBDoSjU8/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div><div class="flex justify-content-center flex-wrap header" style="display:flex;gap:10px"><span class="p-image p-component" data-pc-name="image" data-pc-section="root"><img src="k102.svg" class="" height="40" data-pc-section="image"/></span><div class="button" severity="secondary">_about</div><div class="button" severity="secondary">_photos</div></div><div class="paper"><div class="card"><div><pre style="padding-right:30px;padding-bottom:10px"><code style="white-space:inherit">
████████████████████
█▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█
█▓▓▓▓..           ▓█
█▓▓▓▓..           ▓█
█▓▓▓▓       ...   ▓█
█▓▓▓▓...........  ▓█
█▓▓▓▓.............▓█
█▓▓▓▓.............▓█
█▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓█
████████████████████</code></pre></div><h1>Image editing in node.js</h1><div><h3>Why</h3><p>This is also related to the bot, I have described<!-- --> <a href="/bot">here</a>. Since then, I have found another api that allows reading message history and counting likes on each.</p><p>So, I&#x27;ve had an idea to select the best one for each month.</p><p>It is not that interesting: you just have to use the<!-- --> <a href="https://gram.js.org/">telegram</a> npm package and follow the docs.</p><p>The channel I&#x27;m talking about is called &quot;Postcards from Finland&quot;, therefore I wanted to make those best-liked images look like postcards.</p><p>Programmatically, of course.</p><p>This is my type of fun.</p><h3>How</h3><p>There are several npm packages that provide image manipulation possibilities, but the majority of them require 3rd party stuff like Imagemagick, which I didn&#x27;t want to use - my code should be running on a free tier Oracle VM, so I wanted to keep things as simple as possible.</p><p>So, I came across The JavaScript Image Manipulation Program,<!-- --> <a href="http://jimp-dev.github.io/jimp/">Jimp</a>. Just check out their logo!</p><p>I wanted to achieve a Polaroid-like look, put a postal stamp on and do some writing. The end result should be like that:</p><div style="position:relative;height:400px;cursor:pointer"><button popovertarget="pop_/6/1.jpg"><img alt="Image" src="/6/1.jpg" decoding="async" data-nimg="fill" loading="lazy" style="position:absolute;height:100%;width:100%;left:0;top:0;right:0;bottom:0;object-fit:contain;color:transparent"/></button></div><div id="pop_/6/1.jpg" class="img-dialog" popover="auto"><div class="dlg-header"><p style="color:white">/6/1.jpg</p><button class="close-btn" popovertarget="pop_/6/1.jpg" popovertargetaction="hide">close</button></div><div class="img-container" style="background:url(/6/1.jpg) no-repeat 50% 50%;background-size:contain"></div></div><p>This, obviously, is not something from the channel, this is my middle finger after I&#x27;ve hurt myself a while ago. Anyway.</p><h4>Loading an image</h4><p>First, we&#x27;ll load an image and get it&#x27;s dimensions:</p><pre class="crt"><code class="language-javascript">
const image = await Jimp.read(&#x27;output.jpg&#x27;);
const { width, height } = image.bitmap;
        </code></pre><p>Now let&#x27;s add borders. Either I&#x27;m dumb, or there&#x27;s no built-in way of doing it, so I&#x27;m gonna create white rectangles and slap them onto the image:</p><pre class="crt"><code class="language-javascript">
const border = 20;

const borderH = new Jimp({ width, height: border, color: 0xffffffff });
image.composite(borderH, 0, 0);

const borderV = new Jimp({ width: border, height, color: 0xffffffff });
image.composite(borderV, width - border, 0);
image.composite(borderV, 0, 0);

const borderB = new Jimp({ width, height: border * 4, color: 0xffffffff });
image.composite(borderB, 0, height - border * 4);
        </code></pre><p>This is for the vertical image - the bottom border is 4 times wider.</p><p>Next, I&#x27;ll add a black overlay, to make the image look more printed.</p><pre class="crt"><code class="language-javascript">
const overlay = new Jimp({
    width,
    height: height - border * 3,
    color: 0x000000ff,
  });
overlay.opacity(0.1);

image.composite(overlay, 0, 0);
        </code></pre><p>Adding a stamp is pretty much the same - you load another image and then place it using the &quot;image.composite&quot; method.</p><h4>Text</h4><p>So, the only thing that is missing is the text. It should be easy, right?</p><p>Right?</p><p>So, I&#x27;ve found some &quot;.ttf&quot; font which I liked and downloaded it. First issue I&#x27;ve encountered is that Jimp docs are outdated and &quot;Jimp.loadFont&quot; doesn&#x27;t seem to exist, it should be imported separately.</p><p>The next issue was this:</p><pre class="crt"><code class="language-javascript">
const font = await loadFont(&#x27;.my_font.ttf&#x27;);
        </code></pre><p>has failed with an error, that I honestly did not even understand. But it was clear, that Jimp is unhappy with this font format. I&#x27;ve looked into it&#x27;s GitHub and realized that it uses &quot;.fnt&quot; fonts.</p><p>At this point I&#x27;ve tried using different libs, like &quot;node-canvas&quot;, which, according to the documentation, should be able to use my font.</p><p>It did not. After making several efforts, I&#x27;ve realized I&#x27;m not the only one who has a problem and there&#x27;s an<!-- --> <a href="https://github.com/Automattic/node-canvas/issues/2255">open GitHub issue</a>.</p><p>So, I&#x27;ve decided to try and convert the font.</p><p>Surprisingly, there are different tools for that and some of them just don&#x27;t work. <a href="https://ttf2fnt.com/">This one</a> does.</p><p>A &quot;.fnt&quot; is actually just a bitmap, so this tool has generated an image</p><div style="position:relative;height:400px;cursor:pointer"><button popovertarget="pop_/6/2.png"><img alt="Image" src="/6/2.png" decoding="async" data-nimg="fill" loading="lazy" style="position:absolute;height:100%;width:100%;left:0;top:0;right:0;bottom:0;object-fit:contain;color:transparent"/></button></div><div id="pop_/6/2.png" class="img-dialog" popover="auto"><div class="dlg-header"><p style="color:white">/6/2.png</p><button class="close-btn" popovertarget="pop_/6/2.png" popovertargetaction="hide">close</button></div><div class="img-container" style="background:url(/6/2.png) no-repeat 50% 50%;background-size:contain"></div></div><p>and a file that describes which part of this image corresponds to which letter</p><div style="position:relative;height:400px;cursor:pointer"><button popovertarget="pop_/6/3.png"><img alt="Image" src="/6/3.png" decoding="async" data-nimg="fill" loading="lazy" style="position:absolute;height:100%;width:100%;left:0;top:0;right:0;bottom:0;object-fit:contain;color:transparent"/></button></div><div id="pop_/6/3.png" class="img-dialog" popover="auto"><div class="dlg-header"><p style="color:white">/6/3.png</p><button class="close-btn" popovertarget="pop_/6/3.png" popovertargetaction="hide">close</button></div><div class="img-container" style="background:url(/6/3.png) no-repeat 50% 50%;background-size:contain"></div></div><p>Now, we&#x27;re one step closer!</p><pre class="crt"><code class="language-javascript">
const font = await loadFont(&#x27;.my_font.fnt&#x27;);
        </code></pre><p>This works as expected.</p><p>There&#x27;s one more thing though: some (well, most of them actually) images are landscape, so the text should go vertical. I have spent more time than I&#x27;m willing to admit looking for a way to do that. I have even decided to ask wise people on StackOverflow.</p><p>But than I&#x27;ve had an idea both dumb and brilliant: rotate an image, print text, rotate back.</p><pre class="crt"><code class="language-javascript">
  image.rotate(90);

  image.print({
    font,
    x: border,
    y: width - 50,
    text: &#x27;tome text goes here&#x27;,
  });

  image.rotate(-90);
        </code></pre><h3>Done</h3><p>That&#x27;s it, the code is<!-- --> <a href="https://github.com/k-one-o-two/img-bot">on Github.</a></p><p>I&#x27;ve learned how to <s>mutilate</s>manipulate images in node.js, and surely had some specific fun while doing it.</p></div></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/img","query":{},"buildId":"rQhHGCUC0X3V9CBDoSjU8","nextExport":true,"autoExport":true,"isFallback":false,"scriptLoader":[]}</script></body></html>